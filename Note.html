<!DOCTYPE html>
<html lang="en">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">

<style>
    @import url(./style.css);
    @import url(./code-style.css);

    #note-container {
        gap: 20px;
        min-height: 100%;
    }

    #title {
        color: white;
        text-align: center;
    }

    #tags-container {
        gap: 15px;
        align-items: center;
        justify-content: center;
    }

    #tags-container>span {
        border: 1px solid darkgray;
        color: green;
        padding: 5px;
        font-size: 0.9rem;
    }

    #solution {
        margin-top: 5px;
    }

    #solutions-nav {
        display: flex;
        gap: 10px;
    }

    button.solution-selector {
        color: white;
        border: none;
        background-color: #525CEB;
        padding: 2px;
        font-size: 0.8rem;
    }

    a.link {
        text-decoration: none;
    }

    #links-container {
        margin-top: auto;
    }

</style>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Note</title>
</head>

<body>
    <div id="navbar">
        <!-- placeholder -->
    </div>
    <div id="window">
        <div id="note-container" class="flex-col">
            <h1 id="title">
                <!-- dynamic -->
            </h1>
            <div id="tags-container" class="flex-row">
                <!-- dyanmic -->
            </div>
            <div id="description-container">
                <h5>Description:</h5>
                <p id="description">
                    <!-- dyanmic -->
                </p>
            </div>
            <div id="solutions-container" class="flex-col">
                <h5>Solutions:</h5>
                <div id="solutions-nav">
                </div>
                <div id="solution">

                </div>
                <!-- dyanmic -->
            </div>
            <div id="links-container" class="flex-col">
                <!-- dyanmic -->
            </div>
        </div>
    </div>
</body>

<script type="module">
    import * as domUtils from "./DomUtils.js"
    import hljs from 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/es/highlight.min.js';

    //ELEMENTS IDENTIFIERS
    const SOLUTIONS_CONTAINER_ID = "solution";
    const TAGS_CONTAINER_ID = "tags-container";
    const LINKS_CONTAINER_ID = "links-container";
    const TITLE_ID = "title";
    const DESCRIPTION_ID = "description"
    const SOLUTIONS_NAV_ID = "solutions-nav";
    const SOLUTION_CONTAINER_ID = "solution"
    const DISPLAYED_SOLUTIN_ELEMENT_ID = "displayed-solution"

    let solutions;

    document.addEventListener("DOMContentLoaded", () => {
        const note = fetchNote();
        appendNote(note);

        solutions = note.solutions;
        hilightCode();
    });

    function appendNote(note) {
        domUtils.setTextForElementById(TITLE_ID, note.title);
        appendTags(note.tags);
        domUtils.setTextForElementById(DESCRIPTION_ID, containarizeCodeInString(note.description));
        appendDefaultSolution(note.solutions);
        appendLinks(note.links);
    }

    function appendLinks(links) {
        if (!links) return;
        const linksContainer = document.getElementById(LINKS_CONTAINER_ID);
        linksContainer.appendChild(domUtils.createElementWithText("h5", "Links:"));
        links.forEach(link => {
            const linkElement = domUtils.createElementWithText("a", link.url);
            linkElement.setAttribute("href", link.url);
            linkElement.setAttribute("class", "link")
            linksContainer.appendChild(linkElement);
        });
    }

    function appendDefaultSolution(solutions) {
        const solutionsContainer = document.getElementById(SOLUTIONS_CONTAINER_ID);
        const solution = solutions[0];
        const solutionElement = domUtils.createElementWithText("p", containarizeCodeInString(solution.description));
        solutionElement.setAttribute("id", "displayed-solution")
        solutionsContainer.appendChild(solutionElement);
        appendSolutionsNavigation(solutions.map(solution => solution.id));
    }

    function appendSolutionsNavigation(solutionsIds) {
        const solutionsNavContainer = document.getElementById(SOLUTIONS_NAV_ID);

        for (let i = 0; i < solutionsIds.length; i++) {
            const navButton = document.createElement("button");
            navButton.setAttribute("id", solutionsIds[i]);
            navButton.setAttribute("class", "solution-selector")
            navButton.textContent = i + 1;
            navButton.addEventListener("click", event => {
                changeDisplayedSolution(solutionsIds[i]);
            })
            solutionsNavContainer.appendChild(navButton);
        }
    }

    function changeDisplayedSolution(desiredSolutionId) {
        const displayedSoluionElement = document.getElementById(DISPLAYED_SOLUTIN_ELEMENT_ID);
        const desiredSolutionDescription = solutions.filter(solution => solution.id == desiredSolutionId)[0].description;
        displayedSoluionElement.innerHTML = containarizeCodeInString(desiredSolutionDescription);
        hilightCode();
    }

    function appendTags(tags) {
        const tagsContainer = document.getElementById(TAGS_CONTAINER_ID);
        tags.forEach(tag => {
            const newTag = document.createElement("span");
            newTag.textContent = tag;
            tagsContainer.appendChild(newTag);
        })
    }

    function containarizeCodeInString(string) {
        let regex = /^```[\s\S]*?```$/gm;

        if (!regex.test(string)) return string;
        let newString = string.replaceAll(regex, (match, key) => {
            return wrapCodeInElements(match.slice(3, -3));
        })
        return newString;
    }

    function hilightCode() {
        document.querySelectorAll('pre code').forEach((element) => {
            hljs.highlightElement(element);
        });
    }

    function wrapCodeInElements(code) {
        return `
        <div class="code-section">
            <div class="code-section-header"></div>
                    <pre>
                        <code>${code}</code>
                    </pre>
            </div>
        </div>
        `;
    }

    function fetchNote() {
        return {
            id: 1,
            title: "Lorem ipsum dolor sit amet",
            tags: ["No", "Test", "Yes"],
            visiblity: "public",
            description: `
            Lorem ipsum dolor sit amet consectetur adipisicing elit. Cum rem temporibus atque asperiores veniam. Deserunt quia nisi tenetur fuga perferendis labore dicta optio sed, esse accusantium ratione nihil dolorem fugiat.
\`\`\`
 document.addEventListener("DOMContentLoaded", () => {
 const note = fetchNote();
 appendNote(note);

 solutions = note.solutions;
 });
 \`\`\`
            `,
            solutions: [
                {
                    id: 1,
                    description: `Lorem ipsum dolor sit amet consectetur, adipisicing elit. Laborum facilis, magni earum temporibus ex mollitia rem quia. Nostrum hic eius incidunt! Iure, quae dignissimos minus eaque voluptate doloribus fuga saepe.
\`\`\`
@Override
@SuppressWarnings("unchecked")
public Map<String, ModelsMap> postProcessAllModels(Map<String, ModelsMap> objs) {
    objs.forEach((String modelName, Object properties) -> {

        Map<String, Object> modelProperties = (Map<String, Object>) properties;
        List<HashMap<String, Object>> models = (List<HashMap<String, Object>>) modelProperties.get("models");

        models.stream()
            .map(map -> map.get("model"))
            .forEach(prop -> removeEnumsFromModel((CodegenModel) prop));
    });

    return super.postProcessAllModels(objs);
}                    
\`\`\`
                    `
                },
                {
                    id: 2,
                    description: `Lorem Test Test Test Test
\`\`\`
@Override
@SuppressWarnings("unchecked")
public Map<String, ModelsMap> postProcessAllModels(Map<String, ModelsMap> objs) {
    objs.forEach((String modelName, Object properties) -> {

        Map<String, Object> modelProperties = (Map<String, Object>) properties;
        List<HashMap<String, Object>> models = (List<HashMap<String, Object>>) modelProperties.get("models");

        models.stream()
            .map(map -> map.get("model"))
            .forEach(prop -> removeEnumsFromModel((CodegenModel) prop));
    });

    return super.postProcessAllModels(objs);
}                
\`\`\`
                    `
                }
            ],
            links: [
                {
                    type: "stackoverflow",
                    url: "www.google.com"
                },
                {
                    type: "github",
                    url: "www.test.com"
                }
            ]
        }
    }
</script>

</html>